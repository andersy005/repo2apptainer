# Repo2singularity

_✨ This code is highly experimental! Let the buyer beware ⚠️ ;) ✨_

| CI          | [![GitHub Workflow Status][github-ci-badge]][github-ci-link] [![Code Coverage Status][codecov-badge]][codecov-link] [![pre-commit.ci status][pre-commit.ci-badge]][pre-commit.ci-link] |
| :---------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------: |
| **Docs**    |                                                                     [![Documentation Status][rtd-badge]][rtd-link]                                                                     |
| **Package** |                                                          [![Conda][conda-badge]][conda-link] [![PyPI][pypi-badge]][pypi-link]                                                          |
| **License** |                                                                         [![License][license-badge]][repo-link]                                                                         |

Wrapper around [repo2docker](https://github.com/jupyter/repo2docker) producing Jupyter enabled Singularity images.

## Usage

```bash
$ repo2singularity --help
Usage: repo2singularity [OPTIONS] REPO

  Fetch a repository and build a singularity image.

Options:
  --bind TEXT                   Volumes to mount inside the container, in form
                                src[:dest[:opts]], where src and dest are
                                outside and inside paths.  If dest is not
                                given, it is set equal to src. Mount options
                                ('opts') may be specified as 'ro' (read-only)
                                or 'rw' (read/write, which is the default)
                                [default: ]

  --debug / --no-debug          Turn on debug logging.  [default: False]
  --endpoint-url TEXT           Endpoint URL of the remote builder. Used in
                                conjuction with --remote.  [default: ]

  --force / --no-force          Force the build if the image/sandbox directory
                                exits.  [default: False]

  --image-name TEXT             Name of image to be built. If unspecified will
                                be autogenerated.  [default: ]

  --json-logs / --no-json-logs  Emit JSON logs instead of human readable logs.
                                [default: False]

  --username-prefix TEXT        Username and prefix to use when constructing
                                image URI before pushing it to or pulling it
                                from the registry. For example, user/prefix:
                                `milkshake/chocolate`. Used in conjunction
                                with --push and --run (to pull existing
                                image).  [default: ]

  --ref TEXT                    Remote repository reference to build.
                                [default: master]

  --remote / --no-remote        Build image remotely.  [default: False]
  --run / --no-run              Run container after it has been built.
                                [default: False]

  --push / --no-push            Push singularity image to image registry.
                                [default: False]

  --version                     Print the repo2singularity version and exit.
  --install-completion          Install completion for the current shell.
  --show-completion             Show completion for the current shell, to copy
                                it or customize the installation.

  --help                        Show this message and exit.
```

## Examples

### Example 1: Building image for the first time

```bash
$ repo2singularity --run https://github.com/norvig/pytudes

[I 21:19:17.090 LabApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[W 21:19:17.102 LabApp] No web browser found: could not locate runnable browser.
[C 21:19:17.102 LabApp]

    To access the notebook, open this file in a browser:
        file:///home/USERNAME/.local/share/jupyter/runtime/nbserver-17263-open.html
    Or copy and paste one of these URLs:
        http://HOSTNAME:43111/?token=eb5f94c4ffccd7fff5f2f3a4dfc3aa2fc9e361c1a529bd25
     or http://127.0.0.1:43111/?token=eb5f94c4ffccd7fff5f2f3a4dfc3aa2fc9e361c1a529bd25
```

#### Note on setting up an SSH tunnel

If you are running Singularity on an HPC system, you may need to set up an SSH tunnel to access the jupyter server. On the local machine, start an SSH tunnel:

```bash
ssh -N -L local-port:remote-hostname:remote-port remote-user@remote-host
```

For example:

```bash
ssh -N -L 43111:node2:43111 homersimpson@node2.springfield.io
```

#### Note on requirements

When building an image for the first time, **Docker** and [**Singularity**](https://github.com/hpcng/singularity) need to be running on your machine for this to work.

### Example 2: Build and Push image to [syslabs.cloud](https://cloud.sylabs.io/library)

```bash
repo2singularity --push --username-prefix andersy005/test https://github.com/norvig/pytudes
```

### Example 3: Pull a previously uploaded image from [syslabs.cloud](https://cloud.sylabs.io/library) and run it locally

```bash
repo2singularity --pull --username-prefix andersy005/test --run  https://github.com/norvig/pytudes
```

Note: Pulling an existing singularity image from [syslabs.cloud](https://cloud.sylabs.io/) requires having **singularity** installed.

[github-ci-badge]: https://img.shields.io/github/workflow/status/andersy005/repo2singularity/CI?label=CI&logo=github
[github-ci-link]: https://github.com/andersy005/repo2singularity/actions?query=workflow%3ACI
[codecov-badge]: https://img.shields.io/codecov/c/github/andersy005/repo2singularity.svg?logo=codecov
[codecov-link]: https://codecov.io/gh/andersy005/repo2singularity
[rtd-badge]: https://img.shields.io/readthedocs/repo2singularity/latest.svg
[rtd-link]: https://repo2singularity.readthedocs.io/en/latest/?badge=latest
[pypi-badge]: https://img.shields.io/pypi/v/repo2singularity?logo=pypi
[pypi-link]: https://pypi.org/project/repo2singularity
[conda-badge]: https://img.shields.io/conda/vn/conda-forge/repo2singularity?logo=anaconda
[conda-link]: https://anaconda.org/conda-forge/repo2singularity
[license-badge]: https://img.shields.io/github/license/andersy005/repo2singularity
[repo-link]: https://github.com/andersy005/repo2singularity
[pre-commit.ci-badge]: https://results.pre-commit.ci/badge/github/andersy005/repo2singularity/main.svg
[pre-commit.ci-link]: https://results.pre-commit.ci/latest/github/andersy005/repo2singularity/main
